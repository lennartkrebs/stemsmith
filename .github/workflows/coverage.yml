name: Coverage

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config libcurl4-openssl-dev libfftw3-dev libopenblas-dev lcov gcovr clang-16 llvm-16-tools libomp-16-dev

      - name: Configure (coverage flags)
        run: |
          rm -rf build
          export CC="clang-16" CXX="clang++-16"
          cmake -S . -B build -G Ninja -DENABLE_OPENMP=ON -DCMAKE_BUILD_TYPE=Debug \
                -DSTEMSMITH_ENABLE_COVERAGE=ON \
                -DSTEMSMITH_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --target stemsmith stemsmith_test

      - name: Test (stemsmith only)
        run: ctest --test-dir build --output-on-failure -R stemsmith_test

      - name: Capture coverage
        run: |
          gcovr --root . --object-directory build \
                --gcov-executable "llvm-cov-16 gcov" \
                --filter "$(pwd)/src" --filter "$(pwd)/include" \
                --exclude "$(pwd)/external" --exclude "$(pwd)/thirdparty" --exclude "$(pwd)/tests" --exclude "_deps" --exclude "/usr/" --exclude "/opt/" \
                --txt-metric branch --print-summary --lcov -o coverage.info

      - name: List coverage report
        run: |
          ls -lh coverage.info
          head -n 5 coverage.info
          lcov --list coverage.info --ignore-errors inconsistent,format,negative,unused,unsupported || true
